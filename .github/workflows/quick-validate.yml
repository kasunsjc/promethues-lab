name: ğŸš€ Quick Validation

on:
  push:
    branches: [ "*" ]
  pull_request:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  quick-validate:
    name: âš¡ Quick Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: âœ… Validate Docker Compose
      run: |
        echo "ğŸ” Validating docker-compose.yml..."
        docker compose config --quiet
        echo "âœ… Docker Compose is valid"
        
    - name: âœ… Validate Prometheus Config
      run: |
        echo "ğŸ” Validating Prometheus configuration..."
        docker run --rm \
          --entrypoint="" \
          -v "$(pwd)/config:/etc/prometheus:ro" \
          prom/prometheus:latest \
          promtool check config /etc/prometheus/prometheus.yml
        echo "âœ… Prometheus config is valid"
        
    - name: âœ… Validate Alert Rules
      run: |
        echo "ğŸ” Validating alert rules..."
        docker run --rm \
          --entrypoint="" \
          -v "$(pwd)/config:/etc/prometheus:ro" \
          prom/prometheus:latest \
          promtool check rules /etc/prometheus/alert_rules.yml
        
        # Also validate security rules if they exist
        if [[ -f config/security_rules.yml ]]; then
          echo "ğŸ” Validating security rules..."
          docker run --rm \
            --entrypoint="" \
            -v "$(pwd)/config:/etc/prometheus:ro" \
            prom/prometheus:latest \
            promtool check rules /etc/prometheus/security_rules.yml
        fi
        echo "âœ… Alert rules are valid"
        
    - name: âœ… Validate Alertmanager Config
      run: |
        echo "ğŸ” Validating Alertmanager configuration..."
        docker run --rm \
          --entrypoint="" \
          -v "$(pwd)/config:/etc/alertmanager:ro" \
          prom/alertmanager:latest \
          amtool check-config /etc/alertmanager/alertmanager.yml
        echo "âœ… Alertmanager config is valid"
        
    - name: ğŸ”§ Test Helper Scripts Syntax
      run: |
        echo "ğŸ”§ Testing shell script syntax..."
        bash -n monitoring-helper.sh
        bash -n commands.sh
        bash -n alertmanager-helper.sh
        bash -n k6-load-test.sh
        bash -n import-k6-dashboard.sh
        echo "âœ… All scripts have valid syntax"
        
    - name: ğŸ Test Python Script Syntax
      run: |
        echo "ğŸ Testing Python script syntax..."
        python3 -m py_compile webhook_receiver.py
        echo "âœ… Python script syntax is valid"
