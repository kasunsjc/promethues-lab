name: ğŸ”­ Validate Prometheus Monitoring Stack

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC to catch any issues
    - cron: "0 2 * * *"

env:
  COMPOSE_FILE: docker-compose.yml
  HEALTH_CHECK_TIMEOUT: 120
  ALERT_TEST_TIMEOUT: 180

permissions:
  contents: read
  security-events: write

jobs:
  validate-configs:
    name: ğŸ“‹ Validate Configuration Files
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: âœ… Validate Docker Compose file
        run: |
          echo "ğŸ” Validating docker-compose.yml..."
          docker compose config --quiet
          echo "âœ… Docker Compose configuration is valid"

      - name: âœ… Validate Prometheus configuration
        run: |
          echo "ğŸ” Validating prometheus.yml..."
          docker run --rm \
            --entrypoint="" \
            -v "$(pwd)/config:/etc/prometheus:ro" \
            prom/prometheus:latest \
            promtool check config /etc/prometheus/prometheus.yml
          echo "âœ… Prometheus configuration is valid"

      - name: âœ… Validate Alert Rules
        run: |
          echo "ğŸ” Validating alert_rules.yml..."
          docker run --rm \
            --entrypoint="" \
            -v "$(pwd)/config:/etc/prometheus:ro" \
            prom/prometheus:latest \
            promtool check rules /etc/prometheus/alert_rules.yml

          # Also validate security rules if they exist
          if [[ -f config/security_rules.yml ]]; then
            echo "ğŸ” Validating security_rules.yml..."
            docker run --rm \
              --entrypoint="" \
              -v "$(pwd)/config:/etc/prometheus:ro" \
              prom/prometheus:latest \
              promtool check rules /etc/prometheus/security_rules.yml
          fi
          echo "âœ… Alert rules are valid"

      - name: âœ… Validate Alertmanager configuration
        run: |
          echo "ğŸ” Validating alertmanager.yml..."
          docker run --rm \
            --entrypoint="" \
            -v "$(pwd)/config:/etc/alertmanager:ro" \
            prom/alertmanager:latest \
            amtool check-config /etc/alertmanager/alertmanager.yml
          echo "âœ… Alertmanager configuration is valid"

  test-stack-deployment:
    name: ğŸš€ Test Full Stack Deployment
    runs-on: ubuntu-latest
    needs: validate-configs

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸš€ Start monitoring stack
        run: |
          echo "ğŸ”„ Starting all services..."
          docker compose up -d
          echo "â³ Waiting for services to be ready..."
          sleep 60

      - name: ğŸ” Verify services are running
        run: |
          echo "ğŸ“Š Checking service status..."
          docker compose ps

          # Check if all expected services are running
          services=(prometheus alertmanager grafana mysql mysql-exporter node-exporter nginx nginx-exporter influxdb ubuntu)
          for service in "${services[@]}"; do
            if docker compose ps "$service" | grep -q "Up"; then
              echo "âœ… $service is running"
            else
              echo "âŒ $service is not running"
              exit 1
            fi
          done

      - name: ğŸ¥ Health checks
        run: |
          echo "ğŸ” Performing health checks..."

          # Wait for services to be fully ready
          sleep 30

          # Prometheus health check
          echo "ğŸ” Checking Prometheus..."
          for i in {1..12}; do
            if curl -sf http://localhost:9090/-/ready; then
              echo "âœ… Prometheus is ready"
              break
            fi
            echo "â³ Waiting for Prometheus... (attempt $i/12)"
            sleep 10
          done

          # Alertmanager health check
          echo "ğŸ” Checking Alertmanager..."
          for i in {1..12}; do
            if curl -sf http://localhost:9093/-/ready; then
              echo "âœ… Alertmanager is ready"
              break
            fi
            echo "â³ Waiting for Alertmanager... (attempt $i/12)"
            sleep 10
          done

          # Grafana health check
          echo "ğŸ” Checking Grafana..."
          for i in {1..12}; do
            if curl -sf http://localhost:3000/api/health; then
              echo "âœ… Grafana is ready"
              break
            fi
            echo "â³ Waiting for Grafana... (attempt $i/12)"
            sleep 10
          done

      - name: ğŸ“Š Verify metrics collection
        run: |
          echo "ğŸ“Š Verifying metrics are being collected..."
          
          # Check if Prometheus is scraping targets
          echo "ğŸ” Checking Prometheus targets..."
          targets=$(curl -s http://localhost:9090/api/v1/targets | jq -r '.data.activeTargets[] | select(.health == "up") | .labels.job' | sort -u)
          echo "Active targets: $targets"
          
          # Verify key metrics exist
          echo "ğŸ” Checking key metrics..."
          metrics=("up" "node_cpu_seconds_total" "mysql_up" "nginx_up")
          for metric in "${metrics[@]}"; do
            if curl -s "http://localhost:9090/api/v1/query?query=$metric" | jq -e '.data.result | length > 0' > /dev/null; then
              echo "âœ… Metric '$metric' is available"
            else
              echo "âš ï¸ Metric '$metric' not found"
            fi
          done
          
          # Specifically check Ubuntu service is being monitored
          echo "ğŸ” Checking Ubuntu service metrics..."
          ubuntu_up=$(curl -s "http://localhost:9090/api/v1/query?query=up{job=\"ubuntu\"}" | jq '.data.result | length')
          if [[ "$ubuntu_up" -gt 0 ]]; then
            echo "âœ… Ubuntu service is being monitored"
          else
            echo "âš ï¸ Ubuntu service not found in monitoring targets"
          fi

      - name: ğŸš¨ Test alerting system
        run: |
            echo "ğŸš¨ Testing alerting system..."

            # Start webhook receiver in background
            python3 webhook_receiver.py &
            WEBHOOK_PID=$!
            echo "ğŸ”— Started webhook receiver (PID: $WEBHOOK_PID)"

            # Wait for webhook receiver to start
            sleep 5

            # Stop Ubuntu service to trigger alert
            echo "ğŸ›‘ Stopping Ubuntu service to trigger alert..."
            docker compose stop ubuntu

            # Wait for alert to fire (rules have 1m for condition)
            echo "â³ Waiting for alert to trigger..."
            sleep 90

            # Check if alert is firing in Prometheus
            # Additional check: Verify alert rules are loaded
            echo "ğŸ” Checking if alert rules are loaded in Prometheus..."
            rules=$(curl -s http://localhost:9090/api/v1/rules | jq '.data.groups // []')
            rule_count=$(echo "$rules" | jq '[.[] | .rules[]] | length')

            if [[ "$rule_count" -gt 0 ]]; then
            echo "âœ… Found $rule_count alert rules loaded"
            
            # Check for InstanceDown rule specifically
            instance_down_rules=$(echo "$rules" | jq '[.[] | .rules[] | select(.name == "InstanceDown")]')
            if [[ $(echo "$instance_down_rules" | jq 'length') -gt 0 ]]; then
                echo "âœ… InstanceDown rule is loaded"
            else
                echo "âŒ InstanceDown rule not found"
                echo "ğŸ“‹ Available rules:"
                echo "$rules" | jq -r '.[] | .rules[] | "- \(.name)"' | head -10
            fi
            else
            echo "âŒ No alert rules loaded in Prometheus"
            exit 1
            fi

            # Check if alert reached Alertmanager
            echo "ğŸ” Checking alerts in Alertmanager..."
            sleep 30
            am_alerts=$(curl -s http://localhost:9093/api/v2/alerts | jq '.[] | select(.status.state == "active")')
            if [[ -n "$am_alerts" ]]; then
                echo "âœ… Alerts reached Alertmanager"
            else
                echo "âŒ No alerts in Alertmanager"
                exit 1
            fi

            # Stop webhook receiver
            kill $WEBHOOK_PID || true

            # Restart Ubuntu service
            echo "ğŸ”„ Restarting Ubuntu service..."
            docker compose start ubuntu

      - name: ğŸ”¥ Test k6 load testing
        run: |
          echo "ğŸ”¥ Testing k6 load testing..."

          # Wait for nginx to be ready
          sleep 10

          # Get the actual network name (may vary based on directory name)
          NETWORK_NAME=$(docker network ls --format "{{.Name}}" | grep -E "(prometheus|monitoring)" | head -1)
          echo "ğŸ“Š Using network: $NETWORK_NAME"

          # Run a simple k6 test
          docker run --rm --network "$NETWORK_NAME" \
            -v "$(pwd)/k6-scripts:/scripts" \
            grafana/k6:latest run /scripts/nginx-load-test.js

          echo "âœ… k6 load test completed successfully"

      - name: ğŸ§¹ Cleanup and logs on failure
        if: failure()
        run: |
          echo "ğŸ’¥ Test failed! Collecting logs for debugging..."

          echo "ğŸ“Š Service status:"
          docker compose ps

          echo "ğŸ“œ Docker logs:"
          docker compose logs --tail=50

          echo "ğŸ” System resources:"
          df -h
          free -h

      - name: ğŸ›‘ Stop services
        if: always()
        run: |
          echo "ğŸ›‘ Stopping all services..."
          docker compose down -v
          echo "âœ… Cleanup completed"

      - name: ğŸ›‘ Cleanup
        if: always()
        run: |
          docker compose down -v

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  documentation-check:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check README and documentation
        run: |
          echo "ğŸ“š Checking documentation..."

          # Check if README exists and has content
          if [[ -f "README.md" && -s "README.md" ]]; then
            echo "âœ… README.md exists and has content"
          else
            echo "âŒ README.md missing or empty"
            exit 1
          fi

          # Check if key configuration files are documented
          required_files=("prometheus.yml" "alertmanager.yml" "alert_rules.yml" "docker-compose.yml")
          for file in "${required_files[@]}"; do
            if grep -q "$file" README.md; then
              echo "âœ… $file is documented in README"
            else
              echo "âš ï¸ $file not mentioned in README"
            fi
          done

          # Check if helper scripts are documented
          if grep -q "helper" README.md; then
            echo "âœ… Helper scripts are documented"
          else
            echo "âš ï¸ Helper scripts not documented in README"
          fi

  notify-success:
    name: ğŸ‰ Notify Success
    runs-on: ubuntu-latest
    needs:
      [
        validate-configs,
        test-stack-deployment,
        security-scan,
        documentation-check,
      ]
    if: success()

    steps:
      - name: ğŸ‰ Success notification
        run: |
          echo "ğŸ‰ All validation checks passed!"
          echo "âœ… Configuration validation: PASSED"
          echo "âœ… Stack deployment test: PASSED"
          echo "âœ… Helper scripts test: PASSED"
          echo "âœ… Security scan: PASSED"
          echo "âœ… Documentation check: PASSED"
          echo ""
          echo "ğŸš€ The Prometheus monitoring stack is ready for production!"
